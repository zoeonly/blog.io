<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">

    

    <title>
      从小红点说开 | Zoe 
    </title>

    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    
      <meta name="author" content="Zoe">
    
    

    <meta name="description" content="前几天做东西的时候后台问我网页上的消息提醒小红点能做吗？我发现没有这方面的经验，于是自己研究了一会，整理成这篇博客，服务器端与客户端保持通信的方法有">
<meta property="og:type" content="article">
<meta property="og:title" content="从小红点说开 | Zoe">
<meta property="og:url" content="http://yoursite.com/2015/12/28/从小红点说开/index.html">
<meta property="og:site_name" content="Zoe">
<meta property="og:description" content="前几天做东西的时候后台问我网页上的消息提醒小红点能做吗？我发现没有这方面的经验，于是自己研究了一会，整理成这篇博客，服务器端与客户端保持通信的方法有">
<meta property="og:updated_time" content="2015-12-28T06:25:13.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="从小红点说开 | Zoe">
<meta name="twitter:description" content="前几天做东西的时候后台问我网页上的消息提醒小红点能做吗？我发现没有这方面的经验，于是自己研究了一会，整理成这篇博客，服务器端与客户端保持通信的方法有">
    
    
      <link rel="alternate" href="/atom.xml" title="Zoe" type="application/atom+xml">
    
    
      <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
    
    <link rel="stylesheet" href="/css/uno.css">
    <link rel="stylesheet" href="/css/highlight.css">
    <link rel="stylesheet" href="/css/archive.css">
    <link rel="stylesheet" href="/css/china-social-icon.css">

</head>
<body>
    <a href="https://github.com/zoeonly"><img style="position: absolute; top: 0; left: 0; border: 0;" src="https://camo.githubusercontent.com/c6286ade715e9bea433b4705870de482a654f78a/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f6c6566745f77686974655f6666666666662e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_left_white_ffffff.png"></a>
    <span class="mobile btn-mobile-menu">
        <i class="icon icon-list btn-mobile-menu__icon"></i>
        <i class="icon icon-x-circle btn-mobile-close__icon hidden"></i>
    </span>

    

<header class="panel-cover panel-cover--collapsed">
<meta name="baidu-site-verification" content="H3swprvhPV" />


  <div class="panel-main">

    <div class="panel-main__inner panel-inverted">
    <div class="panel-main__content">

        

        <h1 class="panel-cover__title panel-title"><a href="/" title="link to homepage">Zoe</a></h1>
        <hr class="panel-cover__divider" />

        
        <p class="panel-cover__description">
          Days are numbered
        </p>
        <hr class="panel-cover__divider panel-cover__divider--secondary" />
        

        <div class="navigation-wrapper">

          <nav class="cover-navigation cover-navigation--primary">
            <ul class="navigation">

              
                
                <li class="navigation__item"><a href="/#blog" title="" class="blog-button">博客</a></li>
              
                
                <li class="navigation__item"><a href="/archive" title="" class="">归档</a></li>
              
                
                <li class="navigation__item"><a href="/about" title="" class="">关于</a></li>
              

            </ul>
          </nav>

          <!-- ----------------------------
To add a new social icon simply duplicate one of the list items from below
and change the class in the <i> tag to match the desired social network
and then add your link to the <a>. Here is a full list of social network
classes that you can use:

    icon-social-500px
    icon-social-behance
    icon-social-delicious
    icon-social-designer-news
    icon-social-deviant-art
    icon-social-digg
    icon-social-dribbble
    icon-social-facebook
    icon-social-flickr
    icon-social-forrst
    icon-social-foursquare
    icon-social-github
    icon-social-google-plus
    icon-social-hi5
    icon-social-instagram
    icon-social-lastfm
    icon-social-linkedin
    icon-social-medium
    icon-social-myspace
    icon-social-path
    icon-social-pinterest
    icon-social-rdio
    icon-social-reddit
    icon-social-skype
    icon-social-spotify
    icon-social-stack-overflow
    icon-social-steam
    icon-social-stumbleupon
    icon-social-treehouse
    icon-social-tumblr
    icon-social-twitter
    icon-social-vimeo
    icon-social-xbox
    icon-social-yelp
    icon-social-youtube
    icon-social-zerply
    icon-mail

-------------------------------->

<!-- add social info here -->


<nav class="cover-navigation navigation--social">
  <ul class="navigation">

    
      <!-- Github -->
      <!-- <li class="navigation__item">
        <a href="https://github.com/zoeonly" title="GitHub">
          <i class='icon icon-social-github'></i>
          <span class="label">GitHub</span>
        </a>
      </li>
      -->
      <li class="navigation__item">
        <a href="https://www.facebook.com/profile.php?id=100005454166638" title="Facebook">
          <i class='icon icon-social-facebook'></i>
        </a>
      </li>
      <li class="navigation__item">
        <a href="https://mail.qq.com/" title="Mail:716202820@qq.com">
          <i class='icon icon-mail'></i>
        </a>
      </li>
      <li class="navigation__item">
        <a href="https://www.zhihu.com/people/qiong-yu-zhen" title="ZhiHu">
          <i class='icon icon-social-500px'></i>
        </a>
      </li>
    

  </ul>
</nav>



        </div>

      </div>

    </div>

    <div class="panel-cover--overlay"></div>
  </div>
  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?d2d31aff27b8e9643c33f0fb968e00e1";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
  </script>
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-74730232-1', 'auto');
  ga('send', 'pageview');

</script>

</header>

    <div class="content-wrapper">
        <div class="content-wrapper__inner entry">
            

<article class="post-container post-container--single">

  <header class="post-header">
    
    <h2 class="post-title">从小红点说开</h2>

    

    <div class="post-meta">
      <time datetime="2015-12-28" class="post-meta__date date">2015-12-28</time> 

      <span class="post-meta__tags tags">

          

          
             &#8226; 标签:
            <font class="tags">
              <a class="tags-link" href="/tags/javascript/">javascript</a>, <a class="tags-link" href="/tags/websocket/">websocket</a>
            </font>
          

      </span>
    </div>
    
    

  </header>

  <section id="post-content" class="article-content post">
    <p>前几天做东西的时候后台问我网页上的消息提醒小红点能做吗？我发现没有这方面的经验，于是自己研究了一会，整理成这篇博客，服务器端与客户端保持通信的方法有<a id="more"></a>这样几种：长连接，轮询，和html5的新API web socket，下面就一一讲清楚。</p>
<h3 id="长连接"><a href="#长连接" class="headerlink" title="长连接"></a>长连接</h3><p> longpoll也叫流技术。<br> 目前 http 协议普遍使用的是 1.1 版本, 之前有个 1.0 版本, 两者之间的一个区别是 1.1 支持 http 长连接, 或者叫持久连接.1.0 不支持 http 长连接, 每次一个 http 请求响应后都关闭 tcp 连接, 下个 http 请求会重新建立 tcp 连接.<br> 所谓 http 长连接, 就是多个 http 请求共用一个 tcp 连接; 这样可以减少多次连接 http 请求导致 tcp 建立关闭所产生的时间消耗. http 1.1 中在请求头和相应头中用 connection字段标识是否是 http 长连接, connection: keep-alive, 表明是 http 长连接; connection:closed, 表明服务器关闭 tcp 连接<br> 与 connection 对应的一个字段是 keep-live, http 响应头中出现, 他的格式是 timeout=30, max=5, timeout 是两次 http 请求保持的时间(s), , max 是这个 tcp 连接最多为几个 http 请求重用。<br> 这种机制在并发比较大的情况下，对服务器端的资源是一个极大的考验。</p>
<h3 id="轮询"><a href="#轮询" class="headerlink" title="轮询"></a>轮询</h3><p>也叫ajax轮询或者短轮询，是客户端定时向服务器发送Ajax请求，服务器接到请求后马上返回响应信息并关闭连接，方法一般利用setTimeout或是setInterval定时请求，并返回最新数据，这无疑增加了服务器的负担，浪费了大量的资源。JSONP轮询基本上与HTTP轮询一样，不同之处则是JSONP可以发出跨域请求（不是在你的域内的请求）。</p>
<h3 id="长轮询"><a href="#长轮询" class="headerlink" title="长轮询"></a>长轮询</h3><p>也叫ajax长轮询，是一种阻塞模型，客户端向服务器发送Ajax请求，服务器接到请求后hold住连接，直到有新消息才返回响应信息并关闭连接，客户端处理完响应信息后再向服务器发送新的请求。但服务器hold连接会消耗资源，返回数据顺序无保证，难于管理维护。</p>
<h3 id="comet"><a href="#comet" class="headerlink" title="comet"></a>comet</h3><p>每个客户端始终都有一个向服务器端打开的通信链路。服务器端可以通过在事件到来时立即提交（完成）响应来把事件推给客户端，或者它甚至可以累积再连续发送。因为请求长时间保持打开的状态，故服务器端需要特别的功能来处理所有的这些长生存期请求。<br><strong>使用HTTP流的Comet：</strong><br>从技术上来讲，两种常见的流技术包括Forever Iframe（隐藏的IFrame），或是被用来在JavaScript中创建Ajax请求的XMLHttpRequest对象的多部分（multi-part）特性。<br> 1.在页面里嵌入一个隐蔵iframe，将这个隐蔵iframe的src属性设为对一个长连接的请求或是采用xhr请求，服务器端就能源源不断地往客户端输入数据。<br>缺点： 没有方法可用来实现可靠的错误处理或是跟踪连接的状态，因为所有的连接和数据都是由浏览器通过HTML标签来处理的，因此你没有办法知道连接何时在哪一端已被断开了。<br>2.第二种技术，更可靠一些，是XMLHttpRequest对象上使用某些浏览器（比如说Firefox）支持的multi-part标志。Ajax请求被发送给服务器端并保持打开状态，每次有事件到来时，一个多部分的响应就会通过这同一连接来写入。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> xhr = $.ajaxSettings.xhr();</div><div class="line">xhr.multipart =<span class="literal">true</span>;</div><div class="line">xhr.open(<span class="string">'GET'</span>, <span class="string">'ajax'</span>, <span class="literal">true</span>);</div><div class="line">xhr.onreadystatechange = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">　　	<span class="keyword">if</span> (xhr.readyState == <span class="number">4</span>) &#123;</div><div class="line">　　　　	processEvents($.parseJSON(xhr.responseText));</div><div class="line">　　	&#125;</div><div class="line">&#125;;</div><div class="line">xhr.send(<span class="literal">null</span>);</div></pre></td></tr></table></figure></p>
<p><strong>使用HTTP长轮询的Comet</strong><br>1.正如iframe一样，其目标是把script标签附加到页面上以让脚本执行。服务器端则会：挂起连接直到有事件发生，接着把脚本内容发送回浏览器，然后重新打开另一个script标签来获取下一个事件。<br>优点：因为是基于HTML标签的，所有这一技术非常容易实现，且可跨域工作（缺省情况下，XMLHttpRequest不允许向其他域或是子域发送请求）<br>缺点：类似于iframe技术，错误处理缺失，你不能获得连接的状态或是有干涉连接的能力。</p>
<ol>
<li>也是一种推荐的实现Comet的做法是打开一个到服务器端的Ajax请求然后等待响应。服务器端需要一些特定的功能来允许请求被挂起，只要一有事件发生， 服务器端就会在挂起的请求中送回响应并关闭该请求，完全就像是你关闭了servlet响应的输出流。然后客户端就会使用这一响应并打开一个新的到服务器端 的长生存期的Ajax请求.<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">long_polling</span>(<span class="params"></span>) </span>&#123;</div><div class="line">　　$.getJSON(<span class="string">'ajax'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">events</span>) </span>&#123;</div><div class="line">　　　　	processEvents(events);</div><div class="line">　　　　	long_polling();</div><div class="line">　　	&#125;);</div><div class="line">&#125;</div><div class="line">long_polling();</div></pre></td></tr></table></figure>
</li>
</ol>
<hr>
<p><strong>但无论是轮询，长轮询和长连接，服务器端本质上都是处于被动状态，即客户端不发送请求，服务器端就无法响应的状态。但是web socket就不同了。</strong></p>
<hr>
<h3 id="web-socket"><a href="#web-socket" class="headerlink" title="web socket"></a>web socket</h3><p>WebSocket是为解决客户端与服务端实时通信而产生的技术。WebSocket启用双向的、全双工的通信信道。其本质是先通过HTTP/HTTPS协议进行握手后创建一个用于交换数据的TCP连接， 此后服务端与客户端通过此TCP连接进行实时通信。<br>WebSocket API最伟大之处在于服务器和客户端可以在给定的时间范围内的任意时刻，相互推送信息。在建立连接之后，服务器可以主动传送数据给客户端。<br>在支持WebSocket的浏览器中，在创建socket之后。可以通过onopen，onmessage，onclose即onerror四个事件实现对socket进行响应。</p>
<h3 id="应用"><a href="#应用" class="headerlink" title="应用"></a>应用</h3><p>长轮询一般用在 web im, im 实时性要求高, http 长轮询的控制权一直在服务器端, 而数据是在服务器端的, 因此实时性高;<br>像新浪微薄的im, 朋友网的 im 以及 webQQ 都是用 http 长轮询实现的;<br>NodeJS 的异步机制貌似可以很好的处理 http 长轮询导致的服务器瓶颈问题, 这个有待研究.</p>
<p>http 短轮询一般用在实时性要求不高的地方, 比如新浪微薄的未读条数查询就是浏览器端每隔一段时间查询的.</p>
<h3 id="了解更多"><a href="#了解更多" class="headerlink" title="了解更多"></a>了解更多</h3><p>一个在使用jquery进行长连接的简单实例：<br><a href="http://www.cnblogs.com/vagerent/archive/2010/02/05/1664450.html" target="_blank" rel="external">http://www.cnblogs.com/vagerent/archive/2010/02/05/1664450.html</a><br>长连接与轮询的js实现：<br><a href="http://www.cnblogs.com/hoojo/p/longPolling_comet_jquery_iframe_ajax.html" target="_blank" rel="external">http://www.cnblogs.com/hoojo/p/longPolling_comet_jquery_iframe_ajax.html</a><br>comet:<br><a href="http://kb.cnblogs.com/page/112185/" target="_blank" rel="external">http://kb.cnblogs.com/page/112185/</a><br>web socket：<br><a href="http://www.itpub.net/thread-1373652-1-1.html###" target="_blank" rel="external">http://www.itpub.net/thread-1373652-1-1.html###</a><br><a href="http://my.oschina.net/u/1266171/blog/357488" target="_blank" rel="external">http://my.oschina.net/u/1266171/blog/357488</a></p>

  </section>
  <!-- 多说评论框 start -->
  <div class="ds-thread" data-thread-key="post-从小红点说开" data-title="从小红点说开" data-url="http://yoursite.com/2015/12/28/从小红点说开/"></div>
<!-- 多说评论框 end -->
<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
var duoshuoQuery = {short_name:"xiongmengting"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
     || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
  </script>
<!-- 多说公共JS代码 end -->
</article>


            <footer class="footer">

    <span class="footer__copyright">&copy; 2014-2015. | 由<a href="https://hexo.io/">Hexo</a>强力驱动 | 主题<a href="https://github.com/someus/huno">Huno</a></span>
    
</footer>
        </div>
    </div>

    <!-- js files -->
    <script src="/js/jquery.min.js"></script>
    <script src="/js/main.js"></script>
    <script src="/js/scale.fix.js"></script>
    

    

    <script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript"> 
        $(document).ready(function(){
            MathJax.Hub.Config({ 
                tex2jax: {inlineMath: [['[latex]','[/latex]'], ['\\(','\\)']]} 
            });
        });
    </script>


    

    <script src="/js/awesome-toc.min.js"></script>
    <script>
        $(document).ready(function(){
            $.awesome_toc({
                overlay: true,
                contentId: "post-content",
            });
        });
    </script>


    
    
    <!--kill ie6 -->
<!--[if IE 6]>
  <script src="//letskillie6.googlecode.com/svn/trunk/2/zh_CN.js"></script>
<![endif]-->

</body>
</html>
